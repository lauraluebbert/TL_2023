## Reference genome GCA_003957565.2 (Black17, no W) from Ensembl:
## Downloaded from http://ftp.ensembl.org/pub/release-104/gtf/taeniopygia_guttata/ on March 20 2021
# GTF
wget http://ftp.ensembl.org/pub/release-104/gtf/taeniopygia_guttata/#:~:text=Taeniopygia_guttata.bTaeGut1_v1.p.104.gtf.gz
# Fasta
wget http://ftp.ensembl.org/pub/release-104/fasta/taeniopygia_guttata/dna/Taeniopygia_guttata.bTaeGut1_v1.p.dna.toplevel.fa.gz

## Kallisto bustools
# Build index using kb:
kb ref -i index.idx -g t2g.txt -f1 cdna.fa \
Taeniopygia_guttata.bTaeGut1_v1.p.dna.toplevel.fa.gz \
Taeniopygia_guttata.bTaeGut1_v1.p.104.gtf.gz

## Added WRE sequence to cdna.fa and t2g files generated by kallisto
## Running kallisto index to get the new index with WRE (ignore index made with kb ref before)
kallisto index -i index_WRE.idx cdna.fa

## NOTE: Added -mm (multimapping) option to kb counting to help rescue reads that align to more than one ref gene

# Pseudoalignment and counting (ran before renaming fastq files for cellranger):
kb count --filter bustools \
-i projects/finchseq_data/reference_genome/kallisto/index_WRE.idx \
-g projects/finchseq_data/reference_genome/kallisto/t2g.txt \
-x 10xv3 \
--mm \
--h5ad -t 8 -o "mm_FT-SA112356-ZSOFIA-1C" \
projects/finchseq_data/raw_data/SE7425/FT-SA112356-FT-SPN02267_HT7THDSX2/C1_S1_L001_R1_001.fastq.gz \
projects/finchseq_data/raw_data/SE7425/FT-SA112356-FT-SPN02267_HT7THDSX2/C1_S1_L001_R2_001.fastq.gz

kb count --filter bustools \
-i projects/finchseq_data/reference_genome/kallisto/index_WRE.idx \
-g projects/finchseq_data/reference_genome/kallisto/t2g.txt \
-x 10xv3 \
--mm \
--h5ad -t 8 -o "mm_FT-SA112357-ZSOFIA-2C" \
projects/finchseq_data/raw_data/SE7425/FT-SA112357-FT-SPN02267_HT7THDSX2/C2_S1_L001_R1_001.fastq.gz \
projects/finchseq_data/raw_data/SE7425/FT-SA112357-FT-SPN02267_HT7THDSX2/C2_S1_L001_R2_001.fastq.gz

kb count --filter bustools \
-i projects/finchseq_data/reference_genome/kallisto/index_WRE.idx \
-g projects/finchseq_data/reference_genome/kallisto/t2g.txt \
-x 10xv3 \
--mm \
--h5ad -t 8 -o "mm_FT-SA112358-ZSOFIA-3E" \
projects/finchseq_data/raw_data/SE7425/FT-SA112358-FT-SPN02267_HT7THDSX2/E1_S1_L001_R1_001.fastq.gz \
projects/finchseq_data/raw_data/SE7425/FT-SA112358-FT-SPN02267_HT7THDSX2/E1_S1_L001_R2_001.fastq.gz

kb count --filter bustools \
-i projects/finchseq_data/reference_genome/kallisto/index_WRE.idx \
-g projects/finchseq_data/reference_genome/kallisto/t2g.txt \
-x 10xv3 \
--mm \
--h5ad -t 8 -o "mm_FT-SA112359-ZSOFIA-4E" \
projects/finchseq_data/raw_data/SE7425/FT-SA112359-FT-SPN02267_HT7THDSX2/E2_S1_L001_R1_001.fastq.gz \
projects/finchseq_data/raw_data/SE7425/FT-SA112359-FT-SPN02267_HT7THDSX2/E2_S1_L001_R2_001.fastq.gz

## Cellranger
# Build index using cellranger (does not include WRE)
cellranger mkref --genome=Taeniopygia_guttata_genome \
--fasta=Taeniopygia_guttata.bTaeGut1_v1.p.dna.toplevel.fa \
--genes=Taeniopygia_guttata.bTaeGut1_v1.p.104.gtf \
--nthreads=8

# Data in raw_data_cellranger_format linked to original raw data using ln -s 
# This was to achieve cellranger naming (SampleName_S1_L001_R1_001) without creating a real copy

cellranger count \
--id=C1_cellranger \
--transcriptome=projects/finchseq/Torok-data-analysis/reference_genome/cellranger/Taeniopygia_guttata_genome \
--fastqs=projects/finchseq_data/raw_data/SE7425/FT-SA112356-FT-SPN02267_HT7THDSX2 \
--nosecondary \
--no-bam

cellranger count \
--id=C2_cellranger \
--transcriptome=projects/finchseq/Torok-data-analysis/reference_genome/cellranger/Taeniopygia_guttata_genome \
--fastqs=projects/finchseq_data/raw_data/SE7425/FT-SA112357-FT-SPN02267_HT7THDSX2 \
--nosecondary \
--no-bam

cellranger count \
--id=E1_cellranger \
--transcriptome=projects/finchseq/Torok-data-analysis/reference_genome/cellranger/Taeniopygia_guttata_genome \
--fastqs=projects/finchseq_data/raw_data/SE7425/FT-SA112358-FT-SPN02267_HT7THDSX2 \
--nosecondary \
--no-bam

cellranger count \
--id=E2_cellranger \
--transcriptome=projects/finchseq/Torok-data-analysis/reference_genome/cellranger/Taeniopygia_guttata_genome \
--fastqs=projects/finchseq_data/raw_data/SE7425/FT-SA112359-FT-SPN02267_HT7THDSX2 \
--nosecondary \
--no-bam


## To test:
cellranger count \
--id=E2_cellranger_intron \
--transcriptome=projects/finchseq/Torok-data-analysis/reference_genome/cellranger/Taeniopygia_guttata_genome \
--fastqs=projects/finchseq_data/raw_data/SE7425/FT-SA112359-FT-SPN02267_HT7THDSX2 \
--nosecondary \
--no-bam \
--include-introns
